mode: deployment
image:
  repository: otel/opentelemetry-collector-contrib
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
    kafka:
      brokers:
        - friendly-octo-guacamole-broker-0.friendly-octo-guacamole-kafka-brokers:9092
        - friendly-octo-guacamole-broker-1.friendly-octo-guacamole-kafka-brokers:9092
        - friendly-octo-guacamole-broker-2.friendly-octo-guacamole-kafka-brokers:9092
      protocol_version: "2.0.0"
      topic: friendly-octo-guacamole-logs
      encoding: json
      initial_offset: earliest
    kafka/traces:
      brokers:
        - friendly-octo-guacamole-broker-0.friendly-octo-guacamole-kafka-brokers:9092
        - friendly-octo-guacamole-broker-1.friendly-octo-guacamole-kafka-brokers:9092
        - friendly-octo-guacamole-broker-2.friendly-octo-guacamole-kafka-brokers:9092
      protocol_version: "2.0.0"
      topic: friendly-octo-guacamole-traces
      encoding: otlp_proto
      initial_offset: earliest
  processors:
    transform:
      log_statements:
        - context: log
          statements:
            - set(resource.attributes["service.name"], body["kubernetes"]["container_name"])
            - set(resource.attributes["k8s.namespace.name"], body["kubernetes"]["namespace_name"])
            - set(resource.attributes["k8s.pod.name"], body["kubernetes"]["pod_name"])
  exporters:
    otlphttp/loki:
      endpoint: http://loki-gateway.central-observability:80/otlp
      headers:
        X-Scope-OrgId: production
      sending_queue:
        enabled: false
      retry_on_failure:
        enabled: true
        initial_interval: 5s
        max_interval: 30s
        max_elapsed_time: 0
    kafka/traces:
      brokers:
        - friendly-octo-guacamole-broker-0.friendly-octo-guacamole-kafka-brokers:9092
        - friendly-octo-guacamole-broker-1.friendly-octo-guacamole-kafka-brokers:9092
        - friendly-octo-guacamole-broker-2.friendly-octo-guacamole-kafka-brokers:9092
      protocol_version: "2.0.0"
      topic: friendly-octo-guacamole-traces
      encoding: otlp_proto
    otlp/tempo:
      endpoint: tempo-distributor.central-observability:4317
      tls:
        insecure: true
      retry_on_failure:
        enabled: true
        initial_interval: 5s
        max_interval: 30s
        max_elapsed_time: 0
  service:
    telemetry:
      logs:
        level: warn
    pipelines:
      logs:
        receivers:
          - kafka
        processors:
          - memory_limiter
          - transform
          - batch
        exporters:
          - otlphttp/loki
      traces/ingest:
        receivers:
          - otlp
        processors:
          - memory_limiter
          - batch
        exporters:
          - kafka/traces
      traces/export:
        receivers:
          - kafka/traces
        processors:
          - memory_limiter
          - batch
        exporters:
          - otlp/tempo
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 200m
    memory: 256Mi
replicaCount: 2
